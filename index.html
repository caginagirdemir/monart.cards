<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monart Cards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="index.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Parkinsans:wght@300..800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row" style="height: 100vh;">
            <div class="col-md-3 col-sm-12 bg-blue">
                <div class="container-fluid">
                    <!--monad logo and header-->
                    <div class="row mt-2">
                        <div class="col-md-3 col-sm-12">
                            <img src="./imgs/monad_logo.png" class="rounded" width="65" height="65">
                        </div>
                        <div class="col-md-7 col-sm-12 mt-3">
                            <h4 class="text-white weight-700 text-28 font-park">monart.cards</h4>
                        </div>
                    </div>
                    <div class="row ">
                        <div class="col-12 ">
                            <hr class="text-white"/>
                        </div>
                    </div>
                    <!--<div class="row">
                        <div class="col-12">
                            <span class="text-white weight-700 text-28 font-park">Connect</span>
                        </div>
                    </div>-->
                    <div class="row my-2">
                        <div class="col-12">
                            <button id="connectMetamask" class="btn btn-outline-primary bg-light-blue text-black font-park weight-700">
                                Login with Metamask
                            </button>
                        </div>
                    </div>
                        
                    <!--For demonstration
                    <div class="row my-2">
                        <div class="col-12">
                            <span class="text-white weight-700 text-20 font-park mt-3">
                                500 card remained out of 500
                            </span>
                        </div>
                    </div>-->

                    <!--Dynamic remain demonstratation-->
                    <div class="row ">
                        <div class="col-12">
                            <div class="spinner-border spinner-border-sm text-white" id="loadSpinRemined" role="status">
                            </div>
                            <span class="text-white">waiting for monad testnet...</span>
                            <span id="remainText" class="text-white weight-700 text-20 font-park"></span>
                        </div>
                    </div>

                    <div class="row  mt-1">
                        <div class="col-12 ">
                            <hr class="text-white"/>
                        </div>
                    </div>

                  
                    <div class="row my-1">
                        <div class="col-md-8 col-sm-12">
                            <div class="btn-group">
                                <button class="btn btn-danger btn-lg dropdown-toggle bg-purple" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Designers
                                </button>
                                <ul class="dropdown-menu" id="userDropdown">
                                    <!--designers-->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-12">
                            <span class="text-white">new designers are welcome. Fill the <a href="https://docs.google.com/forms/d/e/1FAIpQLSf8PmNWvxErgDvBdxGITUXbXYQaFdh43iMAu9Ax50dRsn90YQ/viewform" target="_blank">form</a></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <hr class="text-white"/>
                            <h5 class="text-white weight-700 text-28 font-park">Contributors</h5>
                        </div>
                    </div>

                    <div class="row my-2">
                        <div class="col-md-2 col-sm-12">
                            <img src="./imgs/profile-photo.png" class="rounded-circle" width="50" height="50">
                        </div>
                        <div class="col-md-10 col-sm-12">
                            <span class="text-white weight-700 text-20 font-park mt-3">Cagin</span> <br>
                            <span class="text-white weight-500 text-12 font-park mt-3">@caginonthesky</span> <br>
                            <span class="text-white weight-500 text-20 font-park mt-3"><span class="badge text-12 text-white text-primary border border-light">
                                full-access
                            </span>
                            <span class="text-white weight-500 text-20 font-park mt-3"><span class="badge text-12 text-white text-primary border border-primary">
                                developer
                            </span>
                            
                        </span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-2 col-sm-12">
                            <img src="./imgs/gizdusum-profile.jpg" class="rounded-circle" width="50" height="50">
                        </div>
                        <div class="col-md-10 col-sm-12">
                            <span class="text-white weight-700 text-20 font-park mt-3">Gizdusum</span> <br>
                            <span class="text-white weight-500 text-12 font-park mt-3">@gizdusum</span> <br>
                            <span class="text-white weight-500 text-20 font-park mt-3"><span class="badge text-12 text-white text-primary border border-light">
                                full-access
                            </span>
                            <span class="text-white weight-500 text-20 font-park mt-3"><span class="badge text-12 text-white text-primary border border-primary">
                                contributor
                            </span>
                            
                        </div>
                    </div>
                    <br>
                        
                        
                </div>
                
            </div>

            <!--second section-->

            <div class="col-md-4 col-sm-12 bg-purple text-center">
                <div class="container-fluid text-start ">
                    <div class="row p-0">
                        <div class="col-12 p-0">
                            <ol class="list-group list-group-numbered p-0 list-group-flush" id="olElement">
                                <!--Cards-->
                            </ol>
                    </div>
                </div>
                </div>
            </div>

            <!--third section-->
            <div class="col-md-5 col-sm-12">
                <model-viewer id="reveal" 
                            class="w-100" 
                            loading="eager" 
                            camera-controls 
                            touch-action="pan-y" 
                            auto-rotate 
                            tone-mapping="aces" 
                            src="./models/lightcard.glb" 
                            shadow-intensity="1" 
                            alt="A 3D model of a shishkebab" 
                            style="height: 100vh; max-height: 100vh;">
                </model-viewer>
            </div>
        </div>
    </div>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script>
let selectedItem = null;
const modelViewer = document.getElementById("reveal");
let allCardsData = [];
let g_material = null;

function fetchJSONData() {
    let olElem = document.getElementById("olElement");
    olElem.innerHTML = "";

    fetch("./metadata.json?version=" + new Date().getTime())
        .then((res) => {
            if (!res.ok) {
                throw new Error(`HTTP error! Status: ${res.status}`);
            }
            return res.json();
        })
        .then((data) => {
            allCardsData = data.cards;
            populateList(allCardsData);

            const uniqueUsers = getUniqueByUsers(data);
            const dropdownMenu = document.getElementById('userDropdown');
            dropdownMenu.innerHTML = ""; // Dropdown içeriğini temizle

            // "All Designers" seçeneğini ekle
            const allDesignersItem = document.createElement("li");
            allDesignersItem.innerHTML = `<a class="dropdown-item" href="#">All Designers</a>`;
            allDesignersItem.addEventListener("click", () => {
                populateList(allCardsData);
            });
            dropdownMenu.appendChild(allDesignersItem);

            // Kullanıcıları dropdown'a ekle
            uniqueUsers.forEach(user => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${user}</a>`;
                listItem.addEventListener("click", () => filterByUser(user));
                dropdownMenu.appendChild(listItem);
            });
        })
        .catch((error) => console.error("Unable to fetch data:", error));
}


function getUniqueByUsers(jsonData) {
    const cards = jsonData.cards;
    const uniqueByUsers = new Set();
    cards.forEach(card => {
        if (card.byuser) {
            uniqueByUsers.add(card.byuser);
        }
    });
    return Array.from(uniqueByUsers);
}

function selectItem(item) {
    if (selectedItem) {
        selectedItem.setAttribute("style", "background-color: #2E073F !important;");
    }
    item.setAttribute("style", "background-color: #8174A0 !important;");
    selectedItem = item;
}

document.addEventListener('DOMContentLoaded', () => {
    modelViewer.addEventListener('load', () => {
        const model = modelViewer.model;
        if (model) {
            g_material = model.materials.find((mat) => mat.name === "frontside");
            console.log("Model loaded and material assigned.");
            // İlk kartı otomatik tıkla
            const firstCard = document.getElementById("card0");
            if (firstCard) {
                firstCard.click();
            }
        }
    });

    fetchJSONData();
});

async function onItemSelected(card, divSubElem1) {
    // Spinner elementini oluştur
    const spinner = document.createElement("div");
    spinner.setAttribute("class", "spinner-border spinner-border-sm text-white");
    spinner.setAttribute("role", "status");

    divSubElem1.appendChild(spinner);

    try {
        const ipfsLink = "https://coffee-high-perch-467.mypinata.cloud/ipfs/" + card.img;

        if (!g_material) {
            throw new Error("Material not loaded yet!");
        }

        const newTexture = await modelViewer.createTexture(ipfsLink);
        g_material.pbrMetallicRoughness.baseColorTexture.setTexture(newTexture);

        g_material.pbrMetallicRoughness.roughnessFactor = 1.0;
        g_material.pbrMetallicRoughness.metallicFactor = 0.0;

        console.log("Texture applied successfully!");

    } catch (error) {
        console.error("Error loading texture:", error);
    } finally {
        setTimeout(() => {
            spinner.remove();
        }, 500);
    }
}

function populateList(cards) {
    let olElem = document.getElementById("olElement");
    olElem.innerHTML = "";

    cards.forEach((card, i) => {
        let liElem = document.createElement("li");
        liElem.setAttribute("class", "list-group-item d-flex justify-content-between align-items-start bg-purple");
        liElem.setAttribute("id", "card" + i);

        let divElem = document.createElement("div");
        divElem.setAttribute("class", "ms-2 me-auto");

        let divSubElem1 = document.createElement("div");
        divSubElem1.setAttribute("class", "fw-bold");
        divSubElem1.innerText = "monart cards #" + card.id;

        let divSubElem2 = document.createElement("div");
        divSubElem2.innerText = "@" + card.byuser;

        divElem.appendChild(divSubElem1);
        divElem.appendChild(divSubElem2);

        let button = document.createElement("button");
        button.setAttribute("class", "btn btn-success");
        button.innerText = "Mint";

        liElem.appendChild(divElem);
        liElem.appendChild(button);
        olElem.appendChild(liElem);

        // Tıklama olayını ekle
        liElem.addEventListener("click", () => {
            selectItem(liElem);
            onItemSelected(card, divSubElem1); // Tıklanan öğeyi gönderiyoruz
        });
    });
}


function filterByUser(user) {
    const filteredCards = allCardsData.filter(card => card.byuser === user);
    populateList(filteredCards);
    console.log(`Filtered cards for user: ${user}`);
}


document.addEventListener('DOMContentLoaded', fetchJSONData);
</script>